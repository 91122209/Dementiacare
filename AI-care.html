<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>高雄市立聯合醫院失智共照中心 - 失智症問題小幫手</title>
  <link rel="icon" href="one.jpg" />
  <style>
    body { background-color: #e5f4e3; font-family: "微軟正黑體", sans-serif; padding: 20px; }
    .description { text-align: center; font-size: 24px; font-weight: bold; margin: 30px 0 5px 0; }
    .hospital-home-link { text-align: right; font-size: 16px; font-weight: bold; margin-bottom: 5px; }
    .header { display: flex; align-items: center; justify-content: space-between; }
    .logo { max-width: 350px; height: auto; }
    .nav { display: flex; justify-content: flex-end; gap: 20px; flex-wrap: wrap; margin-right: 20px; font-weight: bold; font-size: 16px; }
    .nav a { color: #333; text-decoration: none; }
    .nav a:hover { text-decoration: underline; }
    .nav span.separator { margin: 0 10px; color: #666; }
    h2 { color: #C4571B; font-size: 30px; border-left: 6px solid #C4571B; padding-left: 10px; margin: 20px 0 30px 0; }
    .box { background-color: #fff; border: 1px solid #ccc; padding: 25px; width: 800px; margin: 50px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 10px; }
    .box h3 { text-align: center; font-size: 28px; font-weight: bold; margin: 0 auto 20px; }
    textarea { width: 100%; height: 100px; font-size: 16px; margin-bottom: 15px; }
    .buttons { text-align: center; margin-top: 20px; }
    button { font-size: 18px; padding: 10px 20px; margin: 0 50px; cursor: pointer; border: none; border-radius: 5px; }
    button:first-child { background-color: #1f78b4; color: white; }
    button:last-child  { background-color: #f0c000; color: black; }
    #response { background-color: #f3f3f3; border-left: 5px solid #1f78b4; padding: 15px; min-height: 80px; font-size: 16px; white-space: pre-line; }
    .loading::after { content: " ⏳"; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>
  <div class="hospital-home-link">
    <a href="https://www.kmuh.gov.tw/">高雄市立聯合醫院 首頁</a>
  </div>

  <div class="header">
    <a href="index.html">
      <img src="one.jpg" alt="高雄市立聯合醫院" class="logo" />
    </a>
    <div class="nav">
      <a href="dementiacare.html">關於失智症<br/>相關照護及認識</a>
      <span class="separator">|</span>
      <a href="AI-care.html">關於失智症問題<br/>由AI來協助您</a>
      <span class="separator">|</span>
      <a href="familycare.html">家屬支持團體<br/>哪裡找</a>
      <span class="separator">|</span>
      <a href="downloadcare.html">失智據點&醫事C據點<br/>哪裡找</a>
      <span class="separator">|</span>
      <a href="link.html">相關資源連結</a>
      <span class="separator">|</span>
      <a href="email.html">聯絡我們</a>
    </div>
  </div>

  <h2>關於失智症問題，由 A I 來協助您！</h2>
  <div class="description">AI 不是萬能，但也不是萬萬不能，若有疑慮請直接洽詢共照中心，將會由專人為您解答。<br/></div>

  <div class="box">
    <h3>失智症問題小幫手</h3>
    <textarea id="question" placeholder="請輸入您所遇到的困難或長輩出現的問題……"></textarea>
    <div id="response">AI 將解答您的問題。</div>
    <div class="buttons">
      <button id="btnAsk">搜尋</button>
      <button id="btnReset">清除重寫</button>
    </div>
  </div>

  <script>
    // 寫死正確網域，並在 Console 顯示
    const API_BASE = "https://dementia-r1e8.onrender.com";
    console.log("Using API_BASE:", API_BASE);

    const questionEl = document.getElementById('question');
    const responseBox = document.getElementById('response');
    const btnAsk = document.getElementById('btnAsk');
    const btnReset = document.getElementById('btnReset');

    btnAsk.addEventListener('click', askGPT);
    btnReset.addEventListener('click', resetFields);

    // Enter 送出；Shift+Enter 換行
    questionEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); askGPT(); }
    });

    async function askGPT() {
      const question = questionEl.value.trim();
      if (!question) { alert('請先輸入問題！'); return; }

      responseBox.textContent = 'AI 正在思考中……';
      responseBox.classList.add('loading');

      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 30000);

      try {
        const url = `${API_BASE}/api/chat?_=${Date.now()}`;
        console.log("POST ->", url);

        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question }),
          signal: ctrl.signal
        });

        clearTimeout(timer);
        responseBox.classList.remove('loading');

        const text = await resp.text();
        let data = null;
        try { data = JSON.parse(text); } catch (_) {}

        if (resp.ok && data && data.reply) {
          responseBox.textContent = data.reply;
        } else {
          const detail = (data && (data.error || data.detail)) ? `（詳情：${data.error || data.detail}）` : text;
          responseBox.textContent = `AI 無法提供回覆，請稍後再試。${detail ? "\n" + detail : ""}`;
        }
      } catch (err) {
        clearTimeout(timer);
        responseBox.classList.remove('loading');
        console.error('前端錯誤：', err);
        responseBox.textContent = (err && err.name === 'AbortError')
          ? '連線逾時，請稍後再試。'
          : '發生錯誤，請稍後再試。';
      }
    }

    function resetFields() {
      questionEl.value = '';
      responseBox.textContent = 'AI 將解答您的問題。';
      responseBox.classList.remove('loading');
    }
  </script>
</body>
</html>
